# /tasks - タスク分解

レビュー済みの要件・設計からタスクリストを生成します。
ユーザの入力: $ARGUMENTS

## 引数

- 第1引数: `{slug}` — .review/{slug}.md のファイル名（必須）
- `--merge`: 既存タスクを参照しつつ再生成（任意）

## 前提確認

`.review/{slug}.md` を読み込み、以下を確認:
- ファイルが存在すること
- phase が `design` 以降であること

前提を満たさない場合は「先に `/review-gate:spec` でレビューを完了してください」と伝えて終了。

## タスク生成

要件と設計を分析し、実装タスクリストを生成してください。

### タスク形式

```markdown
## タスク
- [ ] 1. {メジャータスク名}
  - [ ] 1.1 {サブタスク名} (P)
  - [ ] 1.2 {サブタスク名} (P)
  - [ ] 1.3 {サブタスク名}
- [ ] 2. {メジャータスク名}
  - [ ] 2.1 {サブタスク名}
```

### 構造ルール

- **最大2階層**: メジャータスク（1, 2, 3...）とサブタスク（1.1, 1.2...）のみ
- **1タスク1ゴール**: 各タスクは1つの明確な完了条件を持つ
- **テストを含む**: テスト作成のタスクを含めること
- **連番**: メジャータスクは 1 から連番。サブタスクはメジャー番号.連番
- **サブタスクが1つしかないメジャータスクは作らない**: その場合はメジャータスクに昇格させる

### (P) マーカー

並列実行可能なタスクには末尾に ` (P)` を付与する。

**付与基準**（すべて満たす場合のみ）:
- 他の (P) タスクと共有するファイルへの書き込みがない
- 前のタスクの出力を入力として必要としない
- 独立してテスト可能

連続する (P) タスクは並列実行グループとなる。(P) でないタスクは同期バリアとして機能する。

```
- [ ] 1.1 Add entity (P)       → 並列グループ1
- [ ] 1.2 Add repository (P)   → 並列グループ1
- [ ] 1.3 Add migration        → バリア（逐次）
- [ ] 2.1 GET endpoint (P)     → 並列グループ2
- [ ] 2.2 POST endpoint (P)    → 並列グループ2
```

### --merge モード

`--merge` が指定され、既存のタスクセクションがある場合:
- `[x]`（完了済み）のタスクはそのまま保持する
- 未完了タスクは再生成・再構成してよい
- タスク番号は再採番する（完了済み含む）
- 新規タスクは適切な位置に挿入する

## エージェントによるレビュー

タスクリストを生成したら、**ユーザに提示する前に** `tasks-reviewer` エージェントを起動してレビューさせてください。

```
Task(
  subagent_type="tasks-reviewer",
  description="タスク分解レビュー",
  prompt="""
以下の要件・設計・タスクリストを照合してレビューしてください。

## 承認済みの要件
{要件}

## 承認済みの設計
{設計}

## レビュー対象のタスクリスト
{タスクリスト}
"""
)
```

レビュー結果を受けて:
- 指摘があればタスクを改善してから、**指摘内容とその対応をまとめて** ユーザに提示する
- 指摘なしならそのままユーザに提示する

### 承認の確認

> このタスク分解で進めてよいですか？

ユーザが承認するまでこのフェーズに留まってください。

## 保存

承認されたら:
1. `.review/{slug}.md` にタスクセクションを追記（または更新）
2. frontmatter の `phase` を `tasks-ready` に更新
3. ユーザに以下を伝える:

> タスク分解完了。`/review-gate:impl {slug}` で実装を開始できます。
> 特定のタスクだけ実行する場合は `/review-gate:impl {slug} 1.1` のようにタスク番号を指定できます。

### コンテキスト管理

タスク数が多い場合は、以下も案内してください:
> 実装開始前にコンテキストをクリアすることを推奨します。
> タスク間で `/review-gate:impl` を再実行する方が安定動作します。
