# /impl - レビュー済み仕様の実装

このコマンドはレビュー済みの仕様に基づいて実装を開始します。
引数: $ARGUMENTS

## 引数パース

- 第1引数: `{slug}` — .review/{slug}.md のファイル名
- 第2引数（任意）: タスク番号の指定
  - `1` — メジャータスク1（全サブタスク含む）
  - `1.1` — サブタスク1.1のみ
  - `1,2,3` — メジャータスク1, 2, 3
  - `1.1,1.2,2.1` — 特定サブタスクの組み合わせ
  - 省略 — 全未完了タスク

## 前提確認

`.review/` ディレクトリを確認:

- slug が指定されていない場合:
  - .review/ にファイルが1つだけ → それを使う
  - 複数ある場合 → どれを実装するか聞く
  - ファイルがない場合 → 「先に `/review-gate:spec` でレビューを完了してください」と伝えて終了
- slug が指定されている場合: `.review/{slug}.md` を読み込む

以下を確認:
- ファイルが存在すること
- phase が `tasks-ready` 以降であること
- タスクセクションが存在すること

前提を満たさない場合:
- タスクがない → 「先に `/review-gate:tasks {slug}` でタスク分解を完了してください」
- phase が不正 → 適切なコマンドを案内

確認後、frontmatter の `phase` を `implementing` に更新する。

## 実装ルール

1. **plan mode で開始**: 最初に実装計画を立て、ユーザに提示する。設計レビューは済んでいるため承認を待たずに進めてよい

2. **タスク単位で進める**: タスクリストに沿って実装する

3. **逸脱の検知**: 実装中に要件・設計から逸脱しそうになったら、勝手に判断せず必ずユーザに確認する:
   > 実装中に設計と異なる判断が必要になりました: {状況の説明}。どうしますか？

4. **テスト**: 実装にはテストを含めること。テストが仕様の表現になる

## タスク選択

引数で指定されたタスク番号に基づいて実行対象を決定する:
- 引数あり: 指定タスクのみ
- 引数なし: 未チェック（`- [ ]`）のタスク全部

## タスク分類と実行

### 逐次実行（デフォルト）

(P) マーカーに関わらず、タスクを順番に1つずつ実行する。

各タスクについて:

```
Task(
  subagent_type="impl-agent",
  description="タスク {N} を実装",
  prompt="""
## コンテキスト
以下の .review/{slug}.md の内容を参照してください:
{.review/{slug}.md の全内容}

## 対象タスク
タスク {task_number}: {タスクの説明}

## 実行モード: 通常
- TDDサイクル（テスト → 実装 → リファクタ → 検証）で進めてください
- ビルドとテストを実行して動作確認してください
- CLAUDE.md に記載のビルド・テストコマンドを使用してください
- .review/ ディレクトリのファイルは編集しないでください
"""
)
```

タスク完了後、`.review/{slug}.md` のチェックボックスを `[x]` に更新する（コマンド側で実行）。

### 並列実行

(P) マーカーが付いたタスクを並列に実行する。
ユーザが明示的に並列実行を希望した場合、または大量の (P) タスクがある場合に提案する。

#### Phase 1: Implement（並列）

同一並列グループの (P) タスクを、**1つのメッセージで複数の Task 呼び出し**として同時起動する:

```
Task(
  subagent_type="impl-agent",
  description="タスク {N} を実装（並列）",
  prompt="""
## コンテキスト
{.review/{slug}.md の全内容}

## 対象タスク
タスク {task_number}: {タスクの説明}

## 実行モード: 並列
- コード変更のみ実施してください
- ビルドやテストは実行しないでください（後で一括検証します）
- .review/ ディレクトリのファイルは編集しないでください
"""
)
```

#### Phase 2: Verify（検証）

全並列タスク完了後、CLAUDE.md に記載のビルド・テストコマンドを実行する。
エラーがあれば、ファイルパスを基にどのタスクに起因するか分類する。

#### Phase 3: Fix（修正、必要な場合のみ）

エラーのあるタスクだけ修正エージェントを起動する:

```
Task(
  subagent_type="impl-agent",
  resume={前回の agent ID},
  description="タスク {N} のエラー修正",
  prompt="""
## 実行モード: 修正
以下のエラーを修正してください:

{このタスクに関連するエラーメッセージ}

- 上記エラーの修正のみ行ってください
- ビルドやテストは実行しないでください
- .review/ ディレクトリのファイルは編集しないでください
"""
)
```

Phase 2 に戻って再検証する。**最大3回**まで繰り返す。
3回で解決しない場合はユーザに状況を報告し、手動介入を求める。

#### 並列グループ完了後

各タスクのチェックボックスを `[x]` に更新する（コマンド側で実行）。

## 完了処理

**全タスク完了時のみ**実行する（部分実行時はスキップ）:

### Step 1: 最終検証

CLAUDE.md に記載のビルド・テストコマンドを実行し、全テストが通ることを確認する。

### Step 2: 実装レビュー

impl-reviewer エージェントを起動し、実装コードをレビューする:

```
Task(
  subagent_type="impl-reviewer",
  description="実装コードのレビュー",
  prompt="""
## コンテキスト
以下の .review/{slug}.md の内容を参照し、実装コードを要件・設計と照合してレビューしてください:
{.review/{slug}.md の全内容}

## レビュー対象
この実装で変更・追加されたファイル全体を対象にしてください。
Glob と Grep を使って該当ファイルを特定し、Read で内容を確認してください。
"""
)
```

### Step 3: レビュー結果をユーザに提示

レビュー結果をユーザに提示する:
- **指摘あり**: 指摘内容を表示し、修正するか完了に進むかユーザに選択してもらう
  > 実装レビューで以下の指摘がありました:
  > {指摘内容}
  > 修正しますか？それともこのまま完了しますか？
- **指摘なし**: Step 5 へ進む

### Step 4: 修正（ユーザ希望時のみ）

ユーザが修正を希望した場合、指摘に基づいて修正を行う。
修正後、Step 2 に戻って再レビューする。**最大2回**までループ可能。
2回の修正→レビューで解決しない場合はユーザに委ねる:
> 2回の修正サイクルを完了しました。残りの指摘について手動で対応するか、このまま完了するか選択してください。

### Step 5: 知見の統合

以下の情報を適切な場所に反映する:
- アーキテクチャ判断 → CLAUDE.md（今後のエージェントが参照できるように）
- ユーザ向け情報 → README.md
- 特になければスキップ

### Step 6: 一時ファイルの削除

`.review/{slug}.md` を削除する。

### Step 7: 完了報告

> 実装完了。.review のメモは削除しました。
> CLAUDE.md に以下を追記しました: {追記内容の要約、あれば}

## 部分実行時

タスク番号を指定して部分的に実行した場合:
- 完了したタスクのチェックボックスのみ更新
- phase は `implementing` のまま
- `.review/{slug}.md` は削除しない
- 以下を案内:
  > タスク {numbers} が完了しました。残りのタスクは `/review-gate:impl {slug}` で実行できます。

## コンテキスト管理

- 大量のタスクを一度に実行するとコンテキストが膨らむ
- 推奨: 1つの並列グループ or 2-3タスクずつ実行
- タスク間で `/review-gate:impl` を再実行する方が安定する

## 重要

- `.review/` の内容は一時的な作業メモ。実装完了後に残してはいけない
- 永続的に残す価値のある情報だけを CLAUDE.md/README.md に統合する
- spec という成果物を作ることが目的ではない。レビュープロセスを経ることが目的
