# /spec - 厳密レビューモード

このコマンドは要件定義→設計の厳密なレビューフローを開始します。
ユーザの入力: $ARGUMENTS

## あなたの振る舞い

あなたはこれから **厳密レビューモード** に入ります。
通常の「すぐ実装する」振る舞いを停止し、以下のフェーズを順に実行してください。
**各フェーズでユーザの明示的な承認がない限り、絶対に次のフェーズに進まないでください。**

---

## 自己完結性の原則

`.review/` ファイルは以下の原則に従ってください:

- **会話ログを一切見ずに読んでも、要件と設計の全体像が把握できる自己完結した文書** であること
- 「前述の通り」「先ほど議論した」「上記で述べた」のような **会話参照表現は禁止**
- 暗黙の前提は全て明文化すること
- ユーザとの会話で出た具体例・ユースケースも要件の一部として記録すること
- 各設計判断には「なぜその選択をしたか」「他に何を検討したか」を明記すること

---

## Phase 1: 要件整理

ユーザの入力を分析し、以下のセクションで整理してください。
背景・動機・目的は **散文で** 記述し、受け入れ条件は **EARS 形式のリストで** 記述してください。

1. **背景・動機**: なぜこの変更が必要か。現状の問題点は何か（会話の前提知識がなくても理解できるように）
2. **目的**: この変更で何を達成したいのか（1-2文）
3. **スコープ**: 何をやるのか
4. **スコープ外**: 明示的にやらないこと
5. **受け入れ条件**: 各要件に対してテスト可能な条件を EARS 形式で記述（後述）
6. **不明点**: 入力から読み取れなかった情報を質問として列挙

### EARS 形式（推奨フォーマット）

受け入れ条件は以下のパターンで記述することを推奨します。テスト可能であれば他の形式も許容します。
`[対象]` にはシステム名やコンポーネント名を入れてください。

- `When [イベント], the [対象] shall [動作]`（イベント駆動）
- `While [前提条件], the [対象] shall [動作]`（状態駆動）
- `If [条件], the [対象] shall [動作]`（異常系）
- `The [対象] shall [動作]`（常時）

例:
- When ユーザがログインボタンを押す, the 認証サービス shall ユーザの資格情報を検証する
- While データ同期中, the 同期サービス shall 進捗状況を表示する
- If 無効なトークンが検出される, the API shall 401エラーを返す

### 不明点の扱い

不明点がある場合は、まず質問してください。
質問は一度に3つまでに絞り、優先度の高いものから聞いてください。
推測で埋めて進めることは禁止です。

### エージェントによるレビュー

要件をまとめたら、**ユーザに提示する前に** `requirements-reviewer` エージェントを起動してレビューさせてください。

```
Task(
  subagent_type="requirements-reviewer",
  description="要件レビュー",
  prompt="""
以下の要件をレビューしてください。

## レビュー対象
{ここに要件の内容を埋め込む}
"""
)
```

レビュー結果を受けて:
- 指摘があれば要件を改善してから、**指摘内容とその対応をまとめて** ユーザに提示する
- 指摘なしならそのままユーザに提示する

### 承認の確認

要件を提示したら、必ず以下のように聞いてください:

> この理解で合っていますか？修正点があれば教えてください。

ユーザが承認（"ok", "lgtm", "いいよ", "進めて" 等）するまでこのフェーズに留まってください。
修正が入ったら要件を更新して再度確認を求めてください。
**修正が大きい場合は再度エージェントレビューを実行してください。**

---

## Phase 2: 設計

要件が承認されたら、設計フェーズに移行します。

以下を提示してください:

1. **アプローチ**: どう実装するかの方針（技術選定、アーキテクチャ判断）
2. **主要な設計判断**: 重要な判断ごとに以下を明記すること
   - 判断内容
   - 検討した代替案（却下した案を含む）
   - 選択理由
3. **影響範囲**: 変更が及ぶファイル・モジュールのリスト
4. **リスク・トレードオフ**: 残存するリスクや妥協点
5. **確認事項**: 設計上の判断でユーザに委ねたい点

### エージェントによるレビュー

設計をまとめたら、**ユーザに提示する前に** `design-reviewer` エージェントを起動してレビューさせてください。

```
Task(
  subagent_type="design-reviewer",
  description="設計レビュー",
  prompt="""
以下の要件と設計を照合し、レビューしてください。

## 承認済みの要件
{ここに承認済みの要件を埋め込む}

## レビュー対象の設計
{ここに設計の内容を埋め込む}
"""
)
```

レビュー結果を受けて:
- 指摘があれば設計を改善してから、**指摘内容とその対応をまとめて** ユーザに提示する
- 指摘なしならそのままユーザに提示する

### 承認の確認

> この設計方針で進めてよいですか？

ユーザが承認するまでこのフェーズに留まってください。

---

## 保存と完了

設計が承認されたら:

1. `.review/` ディレクトリに作業メモを保存（形式は後述）
2. ユーザに以下を伝える:

> レビュー完了。`/review-gate:tasks {slug}` でタスク分解に進めます。

**このコマンドの中で実装やタスク分解を開始してはいけません。**

---

## Phase 遷移

| 操作 | 前提条件 | 遷移先 |
|------|---------|--------|
| /review-gate:spec | なし | phase: design |
| /review-gate:tasks | phase: design 以降 | phase: tasks-ready |
| /review-gate:impl | phase: tasks-ready 以降 | phase: implementing → done |

---

## 作業メモの保存形式

`.review/` に以下を作成:

```
.review/
└── {slug}.md
```

ファイル内容は以下のテンプレートに従ってください:

```markdown
---
feature: {slug}
started: {date}
phase: design
---

# {機能名}

## 背景・動機

なぜこの変更が必要か。現状の問題点は何か。
この機能を開発する動機と背景を、会話の前提知識なしで理解できるように記述する。

## 要件

### 目的

この変更で達成したいこと。（1-2文）

### スコープ

何をやるのか。

### スコープ外

明示的にやらないこと。

### 受け入れ条件

1. When [イベント], the [対象] shall [動作]
2. If [条件], the [対象] shall [動作]
...

## 設計

### アプローチ

実装の方針。

### 主要な設計判断

| 判断 | 検討した代替案 | 選択理由 |
|------|--------------|----------|
| {判断内容} | {代替案A, 代替案B, ...} | {なぜこの判断をしたか} |

### 影響範囲

変更が及ぶファイル・モジュールのリスト。

### リスク・トレードオフ

残存するリスクや妥協点。

### 確認事項と決定結果

設計上の判断でユーザに委ねた点と、その決定結果。
（Phase 2 の対話で解決した確認事項を記録する）
```

slug はユーザの入力から適切な英語のケバブケースで生成してください。

このファイルは実装中の参照用であり、永続的なドキュメントではありません。
